# -------------------------------------------------------------------------------------------------------
# Terraform Plan [DRIFT]
# -------------------------------------------------------------------------------------------------------
# Run Terraform Plan on the TF_CONFIG_DIRECTORY directory.
# If the terraform backend state file and the Azure resources are not in sync this task will fail. 
#
# -------------------------------------------------------------------------------------------------------
steps:
  - task: Bash@3
    condition: in(variables['env_name'], 'prod','mdlg', 'stg', 'dev')
    inputs:
      filePath: '$(script_path)/$(terraform_version)_terraform-plan-drift.sh'
      arguments: '$(Build.SourcesDirectory) $(env_path) $(tf_concise_plan) $(env_name)'
      failOnStderr: true
    env:
      ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
      ARM_OIDC_TOKEN: $(AZURE_OIDC_TOKEN)
      ARM_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(AZURE_TENANT_ID) 
      ARM_USE_OIDC: $(AZURE_USE_OIDC)            
    displayName: 'Terraform Plan [Drift]'

  # - task: Bash@3 # old secret method to authenticate
  #   condition: in(variables['env_name'], 'prd') 
  #   inputs:
  #     filePath: '$(script_path)/$(terraform_version)_terraform-plan-drift.sh'
  #     arguments: '$(Build.SourcesDirectory) $(env_path) $(tf_concise_plan) $(env_name)'
  #     failOnStderr: true
  #   env:
  #     ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
  #     ARM_CLIENT_SECRET: $(AZURE_CLIENT_SECRET)
  #     ARM_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
  #     ARM_TENANT_ID: $(AZURE_TENANT_ID)         
  #   displayName: 'Terraform Plan [Drift] [prd]'    